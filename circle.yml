machine:
  java:
    version: oraclejdk8
  node:
    version: 5.5.0
dependencies:
  pre:
    - echo $M2_SETTINGS | base64 --decode > ~/.m2/settings.xml
  override:
    - npm install doca -g
    - mvn compile -Dmaven.main.skip
    - mvn dependency:resolve-plugins

compile:
  override:
    - mvn compile javadoc:aggregate
    - mvn install -DskipTests

test:
  override:
    - mvn test

deployment:
  snapshot:
    branch: master
    owner: Nextdoor
    commands:
      - mvn clean deploy -DaltDeploymentRepository=ossrh::default::${SNAPSHOT_LOC} -Dgpg.skip -DskipTests
  release:
    tag: /[0-9]+(\.[0-9]+)*/
    owner: Nextdoor
    commands:
      - sudo apt-get install gnupg2
      - echo $GPG_KEY | base64 --decode > build.gpg
      - gpg --import build.gpg
      - mvn clean verify gpg:sign install:install deploy:deploy -DaltDeploymentRepository=ossrh::default::${RELEASE_LOC} -Dgpg.keyname=${GPG_KEYNAME} -DskipTests
